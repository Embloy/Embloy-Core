<!-- ======= Map Section ======= -->
<section id="map" class="services pt-0 mt-5 pt-4">
  <div class="container" data-aos="fade-up">

    <div class="section-header">
      <span>Available Jobs</span>
      <h2>Available Jobs</h2>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css"/>
    <style>
        #mapid {
            border: 0;
            width: 100%;
            height: 600px;
        }
    </style>
    <div id="mapid"></div>
    <script>
        var southWest = L.latLng(-90, -180);
        var northEast = L.latLng(90, 180);
        var bounds = L.latLngBounds(southWest, northEast);

        var map = L.map('mapid', {
            maxBounds: bounds,
            maxBoundsViscosity: 1.0
        }).setView([48.1374300, 11.5754900], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
            maxZoom: 18,
            tileSize: 512,
            zoomOffset: -1
        }).addTo(map);

        // Get user's location
        var userLat = -1.0;
        var userLng = -1.0;
        navigator.geolocation.getCurrentPosition(function (position) {
            userLat = position.coords.latitude;
            userLng = position.coords.longitude;

            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/jobs_maps');
            xhr.setRequestHeader('Content-Type', 'application/json');
            //  xhr.setRequestHeader('X-CSRF-Token', Rails.csrfToken());
            xhr.onload = function () {
                console.log("TESTTEST");
                // Handle response from server
            };
            xhr.send(JSON.stringify({latitude: position.coords.latitude, longitude: position.coords.longitude}));
            // Redirect user to /jobs_maps
            window.location.href = "/jobs_maps";
            // Add a red marker for the user's location
            var red = L.icon({
                iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
            var userM = L.marker([userLat, userLng], {icon: red}).addTo(map);
            userM.bindPopup('You are here!');

        }, function (error) {
            console.log('Error getting user location:', error.message);
        });


        // Display jobs on map
        <% @jobs.each do |u| %>
        var latitude = <%= u.latitude.nil? ? 37.7749 : u.latitude %>;
        var longitude = <%= u.longitude.nil? ? -122.4194 : u.longitude %>;
        var jobInfo = '<b><%= u.title %></b><br><%= u.description %><br><a href="<%= job_url(u) %>">Apply Now</a>';
        var marker = L.marker([latitude, longitude]).addTo(map);
        marker.bindPopup(jobInfo);
        <%end %>


    </script>
  </div>
</section><!-- End Map Section -->
